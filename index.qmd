---
title: "Patrones latentes de consumo en personas que declaran haber consumido alcohol y marihuana en le último año en la ENPG 2022"
subtitle: "Informe"
author:
  - name: "Ariel Álvarez"
    email: "ariel.alvarez@mail.udp.cl"
  - name: "Natalia Vacas González"
    email: "natalia.vacasgonzalez@gmail.com"

date: "`r Sys.Date()`"
lang: es
format:
  html:
    css: styles.css
    title-block-banner: "#ffffff"
    smooth-scroll: true
    toc: true
    toc-depth: 3
    toc-location: right
    number-sections: true
    df-print: paged
    number-depth: 3
    code-fold: true
    bibliography: ref.bib
    theme: cosmo
    fig-cap-location: bottom
execute:
  python: true
  warning: false
  message: false
  fig-width: 8
  fig-height: 6
---

<img src="logo.png" style="width: 250px; position:absolute; top:0; left:0; padding:10px;"/>

# Relevancia del caso de estudio:

El consumo extendido de susbtancias psicoactivas, tales como el alcohol y la marihuna, constituye un problema de salud pública con consecuencias tanto en el sistema asistencial, como en la productividad a lo largo de la vida, el entorno social y familiar y la salud de las personas usuarias de este tipo de substancias [@Altamirano2024]

El informe "El Consumo de Alcohol en Chile: Situación Epidemiológica" [@SENDA2024] destaca el consumo de alcohol como principal factor de riesgo que causa muerte y discapacidad en Chile, representando el 12,4% de los años de vida saludables perdidos por muerte o discapacidad (AVISA). Junto a lo anterior, también se señala la dependencia del alcohol como una de las cuatro principales enfermedades que generan carga de enfermedad en el país, explicando un 7,7% de los AVISA perdidos.

Adicionalmente, en el informe "Marihuana" [@SENDA2020marihuana] se destaca que Alrededor del 9% de los consumidores adultos desarrollan adicción a la marihuana. Este porcentaje aumenta al 17% si el consumo comienza en la adolescencia y al 25-50% en consumidores diarios. Además de los efectos adictivos, SENDA señala los efectos sobre la salud respiratoria, el incremento del riesgo de psicosis y el deficit cognitivo (particularmente en adolescentes), el desempeño académico y laboral, en términos de ausentismo y menor productividad y los riesgos cariovasculares.

En función de estos antecedentes, se vuelve relevante trazar una estrategia para la identificación de patrones latentes de consumo, percepción de riego y acceso, en personas usuarias de alcohol y marihuana en miras a:

1.  Diseñar políticas y estrategias de intervención más específicas y efectivas para la población consumidora.
2.  Priorizar recursos hacia grupos de mayor riesgo.
3.  Promover una comprensión más matizada del consumo de estas substancias psicoactivas.

A continuación, se presenta el objetivo general y los objetivos específicos del caso.

# Objetivo:

## Objetivo General:

Identificar patrones latentes de consumo, percepción de riego, opinión pública y conductas de riesgo en la conducción en personas que declaran haber consumido alcohol y marihuna en el último año usando datos del Estudio Nacional de Drogas en Población General de Chile 2022.

## Obetivos específicos:

-   Examinar las caracterísiticas sociodemográficas y la distribución regional de las personas que declaran haber consumido alcohol y/ o marihuana en el último año, asi como de otras variables críticas relacionadas con la percepción de riesgo, la opinión pública y la conducción con consumo.

-   Identificar variables relevantes para la elaboración de grupos o perfiles de personas que declaran haber consumido alcohol y/ o marihuana en el último año a través de la extracción de características, aplicando el análisis de componentes principales (PCA)

-   Explorar las agrupaciones producto de la aplicación de de algoritmo de clustering jerarquico aglomerativo.

# Componentes clave de la arquitectura de datos de la propuesta:

El presente proyecto se rige bajo el modelo ETL (Extract, Transform, Load) para el proceso de integración y gestión de datos y, particularmente, en la creación de Data Warehouses o sistema de análisis de datos. A continuación desglosaremos cada una de las etapas que lo componen:

## Extracción:

Inicialmente, se trabajó con un conjunto de bases de datos dumy procedentes del Estudio Nacional de Drogas en Población General (ENPG 2022). Posteriormente, habiendo trabajado el objetivo de unión de bases de datos mediante la fundión fulljoint, se constató la perdida de un número relevante de casos. Particularmente, aquello que respondían a la categoría consumo de marihuna en el último año. Junto a lo anterior, ampliamos la exploración de variables de interés. Por esta razones, se decidió trabajar con la base original del ENPG 2022.

Esta base se encuentra disponible en: <https://www.senda.gob.cl/senda-presenta-principales-resultados-del-15-estudio-de-drogas-en-poblacion-general/>

Para la importación y exploración inicial de las bases de datos dummy y la ENPG 2022 original utilizamos los paquetes"readxl", "haven" y "rio". Junto a estos paquetes instalamos "dplyr" y "tibbles" para la manipulación; "psych", "tidyr", "table1","knitr", "kableExtra" y "survey" para la elaboración de los estadísticos descriptivos; "DT" para la construcción de tablas interactivas; "corrplot", "ggplot2", "plotly" para las visualizaciones; y "renv" para asegurar la reproducibilidad. 

```{r}
knitr::opts_chunk$set(warning = FALSE)
```

```{r, echo=TRUE, results="hide"}

# Lista de paquetes necesarios
paquetes <- c("dplyr", "haven", "rio", "ggplot2", "psych", "tidyr", "table1", "knitr", "kableExtra", "survey", "plotly", "sf", "tmap", "ggthemes", "DT", "tibble", "renv")

# Función para instalar y cargar paquetes
load_packages <- function(paquetes) {
  paquetes_faltantes <- paquetes[!paquetes %in% installed.packages()]
  if(length(paquetes_faltantes) > 0) install.packages(paquetes_faltantes)
  invisible(lapply(paquetes, library, character.only = TRUE))
}

# Ejecutar la función de carga de paquetes
load_packages(paquetes)

```

```{r, warning=FALSE}
# Aquí importamos la base desde github, 

senda <-  import("https://raw.githubusercontent.com/nvacasgonzalez/proyecto_capstone_AA_NV/main/data/senda.xlsx")

```

## Transformación:

A continuación se describe la serie de oporaciones realizadas para manipular nuestra base de datos final, es decir, la base ENPG 2022 original.

Se aplicó el factor de expasión especificado en la encuesta a la base de datos para poder trabajar con valores representativos a nivel nacional y regional

Se construyeron 2 variable de interés de tipo binario:

\- oh_rec: que incluyen a personas que declaran consumo de alcohol en el último mes o hace menos de un mes y más de un año

\- mar_rec: que contempla a personas que declaran consumo de marihuana en el últimos mes o hace menos de un mes pero menos de un año.

```{r, warning=TRUE}
#Seleccionamos variables referentes al consumo de alcohol y marihuana, variables sociodemográficas y factores de expansión.
# Además, generames dos varaibles nuevas sobre la prevalencia del consumo de Alcohol o marihuana

senda <- senda %>% 
  select(FOLIO, OH_1, OH_4, MAR_1, MAR_4, EDAD, REGION, SEXO, DP_12, DP_16, OP_1_1_Rp, OP_1_2_Rp, OP_1_4_Rp, OP_2_2_Rp, OP_2_3_Rp, OP_2_5_Rp, CC_2, CC_3, PR_1_2_Rp, PR_1_3_Rp, PR_1_4_Rp, PR_1_5_Rp, FACTOR_EXPANSION, UPM) %>%
  rename_with(tolower)

#Variable Marihuana 
senda$mar_rec <- with(senda, ifelse(mar_4 %in% 1:2, 1, 0))
senda <- senda[senda$mar_1 %in% c(1, 2), ]
ponderador <- svydesign(ids = ~1, data = senda, weights = ~factor_expansion) # Va el ponderador por cambios en la base
# Variable alcohol
senda$oh_rec <- with(senda, ifelse(oh_4 %in% 1:2, 1, 0))
senda <- senda[senda$oh_1 %in% c(1, 2), ]
ponderador <- svydesign(ids = ~1, data = senda, weights = ~factor_expansion) # Va el ponderador por cambios en la base
```

El resto de alternativas de las variables originales realtivas al consumo de alcohol y marihuana (Hace más de un año, No sabe -88-, No contesta -99- ) fueron recodificadas como valores NA. Este conjunto de valores fue extraido de las operaciones mediante la función ifelse.

Se recodificaron, y normalizaron algunas variables sociodemográficas críticas que nos interesaba incluir en nuestro análisis. Así:

\- la variable de edad fue agrupada por tramos de edad siguiendo la misma agrupación utilizada en el informe oficial de la ENPG 2022.

\- la variable relacionada con el nivel educacional (DP_12) fue recodificada y agrupada para facilitar el análisis. Se diseñaron las siguientes categorías "Sin educación", "Sistema antiguo", "Educación básica", "Educación media", "Técnico", "Universitaria", "Postgrado".

\- se generó una nueva variable a partir de la recodificación de la variable ingresos (DP_16), agrupándola niveles socio económicos "Bajo", "Medio y "Alto". Cabe señalar que esta nueva categorización no es coincidente con su homonima presente en informe de la ENPG (2022). En este informe la categoriza el nivel socioeconomico se genera en función de la la calidad de la vivienda y el barrio.

Por último, se aplicaron técnicas de estandarización al conjunto de variables de interés utilizadas para la generación de clusters en base al PCA y al algoritmo de jerarquización aglomerativa. Entre estas variables se encuentran percepción de riesgo, accesibilidad y conducción.

## Carga:

Nuestro Back Room o ambiente de trabajo donde se realizan todas las transformaciones, integraciones y armonizaciones de los datos es el presente repositorio de Github. Especificamente, nuestra carpeta data donde se enncuentra las base de datos ENPG 2022 original y las bases dumy.

En el caso de el Front Room o ambiente donde se comparten y publican los datos transformados y optimizados para consulta y análisis se ha generado la presente HTML producida en Github para la publicación de resultados.

# Modelo entidad - relación y modelo lógico conceptual.

Nuestro modelo presenta la selección de variables de interés estructuradas en dos tipos de entidades principales:

INDIVIDUO: correspondiente a nuestro unidad básica de observación y lleva aparejada una serie de caractéristicas socio demográficas informativas (SEXO, EDAD, NIVEL DE INGRESOS Y REGIÓN).

DECLARACIONES Y MANIFIESTACIONES: conjunto de variables que recogen el relacionamiento de los individuos con el alcohol y la marihuana en términos de consumo delcarado, opinión pública, percepción del riesgo en el consumo y conduccción previo consumo de esta sustancias.

![Modelo entidad relación](fig/Modelo%20entidad%20relación.png)

# Exploración y análisis descriptivo de variables de interés:

Como primer acercamiento, es posible señalar que la prevalencia del consumo declarado de alcohol en el último año alcanza un 52% en la apoblación chilena. Mientras que el consumo declarado de marihuana en el último año posee una prevalentcia del casi el 11%.

```{r}
# Generar la tabla ponderada para mar_rec
mar_pond <- svytable(~mar_rec, design = ponderador)
tabla_ponderada_mar <- as.data.frame(mar_pond) %>%
  mutate(Porcentaje = round(Freq / sum(Freq) * 100, 1)) %>%
  rename(Frecuencia = Freq) %>%
  filter(mar_rec == 1) %>%  # Filtrar de consumidores
  mutate(Consume = "Consume Marihuana")  # Título

# Generar la tabla ponderada para oh_rec
oh_pond <- svytable(~oh_rec, design = ponderador)
tabla_ponderada_oh <- as.data.frame(oh_pond) %>%
  mutate(Porcentaje = round(Freq / sum(Freq) * 100, 1)) %>%
  rename(Frecuencia = Freq) %>%
  filter(oh_rec == 1) %>%  # Filtro de consumidores 
  mutate(Consume = "Consume Alcohol")  # Título 

# Unir ambas tablas en una sola
tabla_consumo_combinada <- bind_rows(tabla_ponderada_mar, tabla_ponderada_oh) %>%
  select(Consume, Frecuencia, Porcentaje)  # Seleccionar y renombrar columnas

# Mostrar la tabla combinada en HTML
tabla_consumo_combinada %>%
  rename(
    "Tipo de Consumo" = "Consume",  # Renombrar la columna 'Consume'
    "Número de observaciones" = "Frecuencia",  # Renombrar la columna 'Frecuencia'
    "Porcentaje" = "Porcentaje"  # Mantener 'Porcentaje' igual
  ) %>%
  kable("html", caption = "Tabla de tipo de consumo") %>% #Titulo de la tabla
  kable_styling("striped", full_width = F) %>%
  kable_styling(font_size = 18) %>% # Tamaño de la letra
  add_header_above(c(" " = 1, "Estadísticos" = ncol(tabla_consumo_combinada) - 1))
```

A continuación examinaremos los valores relativos a otras variables sociodemográficas de interés tales como sexo, tramo etario, nivel de educación y tramo de ingreso.

## Sexo y consumo declarado de alcohol y marihuana en el último año

En términos generales, la población masculina lidera el consumo declarado de alcohol y de marihuana en el último año, representando un 42% y un 13% de la población nacional. Sin embargo, la mayor distancia por género en términos de prevalencia de consumo declarado se produce con respecto a la marihuana. Donde las mujeres registran 5,7 puntos menos de consumo que los hombres, representando un 6,8% del total de la población chilena.

```{r}
# Tabla de Porcenajaje sexo
tabla_porcentajes_sexo <- senda %>%
  filter(mar_rec == 1 | oh_rec == 1) %>%  # Filtrar valores 1 de mar_rec y oh_rec
  mutate( Variable = case_when(
      mar_rec == 1 ~ "Consume Marihuana",
      oh_rec == 1 ~ "Consume Alcohol" ),
    sexo = recode(sexo, `1` = "Hombre", `2` = "Mujer")) %>% 
  group_by(sexo, Variable) %>%
  summarise( Frecuencia = sum(factor_expansion),  # Sumar ponderaciones por grupo
    .groups = "drop") %>%
  mutate(
    Porcentaje = round(Frecuencia / sum(Frecuencia) * 100, 1),  # Calcular porcentaje total
    Porcentaje = paste0(Porcentaje, "%")) %>%  # Agregar el símbolo de porcentaje
  select(Sexo = sexo, Variable, Porcentaje) %>%  # Renombrar columnas para claridad
  pivot_wider(names_from = Sexo, values_from = Porcentaje)  # Convertir columnas por sexo

# Visualización de la tabla en HTML
tabla_porcentajes_sexo %>%
  rename("Tipo de Consumo" = "Variable") %>%
  kable("html", caption = "Porcentaje de consumo por sexo") %>%
  kable_styling("striped", full_width = F) %>%
  kable_styling(font_size = 15)
```

```{r}
# Preparar los datos en formato largo
tabla_porcentajes_sexo_long <- tabla_porcentajes_sexo %>%
  pivot_longer(cols = c("Hombre", "Mujer"), 
               names_to = "Sexo", 
               values_to = "Porcentaje") %>%
  mutate(Porcentaje = as.numeric(gsub("%", "", Porcentaje)))  # Convertir Porcentaje a numérico


# Gráfico
grafico_1 <- ggplot(tabla_porcentajes_sexo_long, aes(x = Variable, y = Porcentaje, fill = Sexo)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(
    aes(label = paste0(round(Porcentaje, 1), "%")),
    position = position_dodge(width = 0.9),
    vjust = -0.5
  ) +
  labs(title = "Porcentaje de Consumo por Sexo", x = "Tipo de Consumo", y = "Porcentaje") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +  # Formato de porcentaje en el eje Y
  scale_fill_manual(values = c("Hombre" = "lightblue", "Mujer" = "lightcoral")) +  # Colores personalizados
  theme_classic()

grafico_1

```

## Edad y consumo declarado de alcohol y marihuana en el último año

La exploración descriptiva de la variable edad nos muestra una edad promedio de 42 años. Esta coincide con el valor central (mediana), evidenciando una distribución simetrica de las edades. En cuanto a la desviación estándar, existe una dispersión significativa de 15,24 años, incluyendo a personas jóvenes y mayores con edades alejadas del promedio. Por otro lado exite un leve sego (-0,11) hacia edades más jovenes.

```{r, echo=TRUE, results="hide"}
describe(senda$edad)
senda <- senda %>%
  mutate(
    tramos_edad = case_when(
      edad >= 12 & edad <= 18 ~ "12 a 18 años",
      edad >= 19 & edad <= 25 ~ "19 a 25 años",
      edad >= 26 & edad <= 34 ~ "26 a 34 años",
      edad >= 35 & edad <= 44 ~ "35 a 44 años",
      edad >= 45 & edad <= 65 ~ "45 a 65 años"
      ))
# Tabla de porcentajes de Edad
tabla_porcentajes_edad <- senda %>%
  filter(mar_rec == 1 | oh_rec == 1) %>%  # Filtro de solo los valores 1 
  mutate(Variable = case_when(
    mar_rec == 1 ~ "Consume Marihuana",
    oh_rec == 1 ~ "Consume Alcohol"
  )) %>%
  group_by(tramos_edad, Variable) %>% 
  summarise(Frecuencia = sum(factor_expansion),  # Sumar ponderaciones por grupo
            .groups = "drop") %>%
  mutate(Porcentaje = round(Frecuencia / sum(Frecuencia) * 100, 1)) %>%
  mutate(Porcentaje = paste0(Porcentaje, "%")) %>%  # Agregar el símbolo de porcentaje
  select(-Frecuencia) %>%  # Eliminar la columna 'Frecuencia' si no es necesaria
  pivot_wider(names_from = tramos_edad, values_from = Porcentaje)  # Convertir columnas

```

```{r}
# Crear un data frame o tibble con los datos, incluyendo los nuevos estadísticos
df_interactivo <- tibble(
  vars = 1,
  n = 17378,
  mean = round(41.99, 2),
  sd = round(15.24, 2),
  median = 42,
  trimmed = round(42.33, 2),
  mad = round(19.27, 2),
  min = 12,
  max = 65,
  range = 53,        # Rango (max - min)
  skew = -0.11,      # Skew (sesgo)
  kurtosis = -1.17,  # Kurtosis
  se = round(0.12, 2)  # Error estándar
)

# Crear la tabla interactiva
datatable(
  df_interactivo,
  options = list(
    dom = 't', # Muestra solo la tabla sin filtros adicionales
    pageLength = 5,
    columnDefs = list(list(className = 'dt-center', targets = "_all")) # Centra los valores
  )
)



```

En cuanto al consumo declaradado de alcohol en el último año, el grupo etario que muestra mayor prevalencia es el conformado por personas mayores de 45 años (30,1%) seguido de personas con edades comprendidas entre los 12 y 19 años (18,1%) y entre los 26 y 34 (17,9%). Por su parte, el consumo declarado de marihuana en el último años posee su mayor prevalencia entre personas de 26 a 34 año (7,1%) y personas que se encuentran en el tramo etario de de 19 a 25 años (5,5%).

```{r}
# Preparar los datos en formato largo
tabla_porcentajes_edad_long <- tabla_porcentajes_edad %>%
  pivot_longer(cols = c("12 a 18 años", "19 a 25 años", "26 a 34 años", "35 a 44 años", "45 a 65 años"), 
               names_to = "TramosEdad", 
               values_to = "Porcentaje") %>%
  mutate(Porcentaje = as.numeric(gsub("%", "", Porcentaje)))  # Convertir Porcentaje a numérico

# Gráfico
grafico_2 <- ggplot(tabla_porcentajes_edad_long, aes(x = Variable, y = Porcentaje, fill = TramosEdad)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(
    aes(label = paste0(round(Porcentaje, 1), "%")),
    position = position_dodge(width = 0.9),
    vjust = -0.5
  ) +
  labs(title = "Porcentaje de Consumo por Tramos de Edad", x = "Tipo de Consumo", y = "Porcentaje") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +  # Formato de porcentaje en el eje Y
  scale_fill_manual(values = c("12 a 18 años" = "lightblue", "19 a 25 años" = "lightgreen", 
                               "26 a 34 años" = "lightcoral", "35 a 44 años" = "lightskyblue", 
                               "45 a 65 años" = "lightgoldenrodyellow")) +  # Colores personalizados
  theme_classic()

grafico_2

```

## Nivel educacional y consumo declarado de alcohol y marihuana en el último año

Centrándo la exploración en el nivel educacional de las personas con consumo declarado en el último año, aquellas cuyos estudios llegan a hasta la educación media concentran la mayor prevalencia de consumo declarado tanto en alcohol (31,6%) como en marihuana (7,1%). Seguidas de las personas con estudios universitarios que presentan la segunda mayor prevalencia tanto en el consumo de alcohol (22,8%) como de marihuana (6,3%) a nivel nacional.

```{r}
# Recodificación de nivel educacional
senda <- senda %>% 
  mutate(educ = case_when(
    dp_12 == 1 ~ "Sin educación", 
    dp_12 %in% c(3, 5, 7) ~ "Sistema antiguo", 
    dp_12 == 4 ~ "Educación básica",  
    dp_12 %in% c(6, 8) ~ "Educación media", 
    dp_12 == 9 ~ "Técnico", 
    dp_12 == 10 ~ "Universitaria", 
    dp_12 %in% 11:13 ~ "Postgrado" )) %>%
  arrange(desc(educ))

# Tabla de Porcentajes de Nivel educacional y asignación de valores para ordenar tabla
tabla_porcentajes_educacion <- senda %>%
  filter(mar_rec == 1 | oh_rec == 1) %>%  # Filtrar valores 1 de mar_rec y oh_rec
  mutate(Variable = case_when(
      mar_rec == 1 ~ "Consume Marihuana",
      oh_rec == 1 ~ "Consume Alcohol"),
    educ = recode(educ, 
      `1` = "Sin educación",
      `2` = "Sistema antiguo",
      `3` = "Educación básica",
      `4` = "Educación media",
      `5` = "Técnico",
      `6` = "Universitaria",
      `7` = "Postgrado"),
    educ = factor(educ, levels = c(
      "Sin educación", "Sistema antiguo", "Educación básica",
      "Educación media", "Técnico", "Universitaria", "Postgrado"
    ))) %>%  # Orden personalizado
  group_by(educ, Variable) %>%
  filter(!is.na(educ)) %>%
  summarise( Frecuencia = sum(factor_expansion),  # Sumar ponderaciones por grupo
    .groups = "drop") %>%
  mutate(
    Porcentaje = round(Frecuencia / sum(Frecuencia) * 100, 1),  # Calcular porcentaje total
    Porcentaje = paste0(Porcentaje, "%")  # Agregar el símbolo de porcentaje
  ) %>%
  select(educ = educ, Variable, Porcentaje) %>%  # Renombrar columnas
  pivot_wider(names_from = educ, values_from = Porcentaje)  # Convertir columnas por educación

# Visualización en HTML
tabla_porcentajes_educacion %>%
  rename("Tipo de Consumo" = "Variable") %>%
  kable("html", caption = "Porcentaje de consumo por nivel educativo") %>%
  kable_styling("striped", full_width = F) %>%
  kable_styling(font_size = 15)


```

```{r}
# Gráfico Nivel Educacional
# Transformar a formato largo
tabla_porcentajes_educacion_long <- tabla_porcentajes_educacion %>%
  pivot_longer(
    cols = c("Sin educación", "Sistema antiguo", "Educación básica", "Educación media", "Técnico", "Universitaria", "Postgrado"),
    names_to = "NivelEducacional",
    values_to = "Porcentaje")%>% 
  mutate( Porcentaje = as.numeric(gsub("%", "", Porcentaje)))  # Convertir Porcentaje

# Crear el gráfico
grafico_3 <- ggplot(tabla_porcentajes_educacion_long, aes(x = Variable, y = Porcentaje, fill = NivelEducacional)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(
    aes(label = paste0(round(Porcentaje, 1), "%")),
    position = position_dodge(width = 0.9),
    vjust = -0.5) +
  labs(
    title = "Porcentaje de Consumo según Nivel Educacional",
    x = "Tipo de Consumo",
    y = "Porcentaje",
    fill = "Nivel Educacional"
  ) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +  # Formato 
  scale_fill_manual(
    values = c(
      "Sin educación" = "lightblue", "Sistema antiguo" = "lightgreen", 
      "Educación básica" = "lightcoral", "Educación media" = "lightskyblue", 
      "Técnico" = "lightgoldenrodyellow", "Universitaria" = "orchid", 
      "Postgrado" = "tomato"
    )) +  
 theme_classic()

grafico_3
```

## Nivel de ingresos y consumo declarado de alcohol y marihuana en el último año.

En términos de nivel socioeconómico, las personas clasificadas en el nivel socioeconómico medio muestran porcentaje más alto de consumo de alcohol (38.3%), seguido por el Bajo (29.8%) y, finalmente, el Alto (12.6%). De forma similar, el consumo declarado de merihuna en el último año muestra la mayor prevalencia el nivel socioeconómico medio (9%), seguido por el Bajo (7.3%) y el Alto (2.9%). En síntesis, el consumo declarado de alcohol y marihuana en el último año disminuye conforme aumenta el nivel socioeconómico, siendo más alto en el nivel Medio y más bajo en el nivel Alto.

```{r}
# Recodificación tramo de ingresos
senda <- senda %>% 
  mutate(nse = case_when(
    dp_16 %in% 1:5 ~ "Nivel socioeconomico Bajo", 
    dp_16 %in% 6:8 ~ "Nivel socioeconomico Medio",  
    dp_16 %in% 9:10 ~ "Nivel socioeconomico Alto"  
  )) 
# Tabla porcentaje de Tramos de Ingresos
tabla_porcentajes_nse <- senda %>%
  filter(mar_rec == 1 | oh_rec == 1) %>% # Filtro de solo los valores 1 
   filter(!is.na(nse)) %>%
  mutate(Variable = case_when(
    mar_rec == 1 ~ "Consume Marihuana",
    oh_rec == 1 ~ "Consume Alcohol")) %>%  
  mutate(nse = recode(nse, 
                      `1` = "Nivel socioeconomico Bajo",
                      `2` = "Nivel socioeconomico Medio", 
                      `3` = "Nivel socioeconomico Alto")) %>%  # Recodificar nse
  mutate(nse = factor(nse, levels = c("Nivel socioeconomico Bajo", 
                                      "Nivel socioeconomico Medio", 
                                      "Nivel socioeconomico Alto"))) %>%  # Orden personalizado de los niveles
  group_by(nse, Variable) %>% 
  summarise(Frecuencia = sum(factor_expansion),  # Sumar ponderaciones por grupo
            .groups = "drop") %>%
  mutate(Porcentaje = round(Frecuencia / sum(Frecuencia) * 100, 1)) %>%
  mutate(Porcentaje = paste0(Porcentaje, "%")) %>%  # Agregar el símbolo de porcentaje
  select(-Frecuencia) %>%  # Eliminar la columna 'Frecuencia'
  pivot_wider(names_from = nse, values_from = Porcentaje)  # Convertir columnas de 'nse'


# Visualización de la tabla
tabla_porcentajes_nse %>%
  rename(
    "Tipo de Consumo" = "Variable"  # Renombrar la columna 'Variable'
  ) %>%
  kable("html", caption = "Porcentaje de consumo por tipo y Nivel socioecónomico") %>%
  kable_styling("striped", full_width = F) %>%
  kable_styling(font_size = 15)

```

```{r}
# Preparar los datos en formato largo
tabla_porcentajes_nse_long <- tabla_porcentajes_nse %>%
  pivot_longer(cols = c("Nivel socioeconomico Bajo", "Nivel socioeconomico Medio", "Nivel socioeconomico Alto"), 
               names_to = "NivelSocioeconomico", 
               values_to = "Porcentaje") %>%
  mutate(Porcentaje = as.numeric(gsub("%", "", Porcentaje)))  # Convertir Porcentaje a numérico

# Gráfico
grafico_3 <- ggplot(tabla_porcentajes_nse_long, aes(x = Variable, y = Porcentaje, fill = NivelSocioeconomico)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(
    aes(label = paste0(round(Porcentaje, 1), "%")),
    position = position_dodge(width = 0.9),
    vjust = -0.5
  ) +
  labs(title = "Porcentaje de Consumo por Nivel Socioeconómico", x = "Tipo de Consumo", y = "Porcentaje") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +  # Formato de porcentaje en el eje Y
  scale_fill_manual(values = c("Nivel socioeconomico Bajo" = "lightblue", 
                               "Nivel socioeconomico Medio" = "lightgreen", 
                               "Nivel socioeconomico Alto" = "lightcoral")) +  # Colores personalizados
  theme_classic()

grafico_3


```

## Regiones y consumo declarado de alcohol y marihuana en el último año.

Si abordamos el análisis exploratorio según región, aquellas que muestran un alto procentaje de prevalencia del consumo declarado de alcohol y marihuana en el último año son Coquimbo, Valparaíso y Maule con más del 75% en alcohol y más del 20% en marihuana. Los Lagos destaca por tener el consumo declarado de marihuana más alto (31.3%) del país, aunque su consumo declarado de alcohol es relativamente bajo (68.7%); el menor de todas las regiones. Esto podría indicar patrones de consumo diferenciados según la sustancia.

Respecto a las regiones con moderación en el consumo declarado de ambas sustancias, Antofagasta y Ñuble presentan consumos bajos de marihuana (alrededor del 12.6% y 12.8%, respectivamente) y valores intermedios o altos en consumo de alcohol. Tarapacá tiene el porcentaje más bajo de prevalencia de consumo declarado de marihuana (9.1%) pero el más alto de alcohol (90.9%). Esto podría indicar un comportamiento divergente respecto al consumos de estas sustancias en esta región.

En síntesis, es posible señalar que las regiones del norte (como Tarapacá y Antofagasta) tienden a tener un consumo declarado de alcohol más alto pero un consumo delarado de marihuana más bajo. Mientras que, algunas regiones del sur (como Los Lagos y Los Ríos) tienden a tener un consumo declarado de marihuana más alto, aunque el consumo delcarado de alcohol varía ampliamente.

Por último, algunas regiones centrales ( como por ejemplo Maule, Valparaíso y Coquimbo) combinan altos consumos de ambas sustancias, mostrando una tendencia más equilibrada entre ellas.

```{r}
etiquetas_regiones <- c(
  "1" = "Región de Arica y Parinacota",
  "2" = "Región de Tarapacá",
  "3" = "Región de Antofagasta",
  "4" = "Región de Atacama",
  "5" = "Región de Coquimbo",
  "6" = "Región de Valparaíso",
  "7" = "Región Metropolitana de Santiago",
  "8" = "Región del Libertador General Bernardo O'Higgins",
  "9" = "Región del Maule",
  "10" = "Región de Ñuble",
  "11" = "Región del Biobío",
  "12" = "Región de La Araucanía",
  "13" = "Región de Los Ríos",
  "14" = "Región de Los Lagos",
  "15" = "Región de Aysén del General Carlos Ibáñez del Campo",
  "16" = "Región de Magallanes y de la Antártica Chilena")

# Tabla Porcentajes region
tabla_porcentajes_region <- senda %>%
  filter(mar_rec == 1 | oh_rec == 1) %>%  # Filtro de solo los valores 1
  filter(!is.na(region)) %>%  # Asegurar que no haya valores NA en región
  mutate(
    region = recode(as.character(region), !!!etiquetas_regiones)) %>%  # Aplicar etiquetas 
  group_by(region, Variable = case_when(
    mar_rec == 1 ~ "Marihuana (%)",
    oh_rec == 1 ~ "Alcohol (%)" )) %>%
  summarise(Frecuencia = sum(factor_expansion), .groups = "drop") %>%  # Sumar ponderaciones
  group_by(region) %>%  # Agrupar por región
  mutate(
  Porcentaje = round(Frecuencia / sum(Frecuencia) * 100, 1)  # Calcular porcentaje dentro de cada región
  ) %>%
  select(-Frecuencia) %>%  # Eliminar columna Frecuencia si no es necesaria
  pivot_wider(
    names_from = Variable, 
    values_from = Porcentaje,
    values_fill = 0)  # Rellenar valores faltantes con 0
# Tabla HTML
```

```{r}
tabla_porcentajes_region <- senda %>%
  filter(mar_rec == 1 | oh_rec == 1) %>%  # Filtro de solo los valores 1
  filter(!is.na(region)) %>%  # Asegurar que no haya valores NA en región
  mutate(
    region = recode(as.character(region), !!!etiquetas_regiones)) %>%  # Aplicar etiquetas 
  group_by(region, Variable = case_when(
    mar_rec == 1 ~ "Marihuana (%)",
    oh_rec == 1 ~ "Alcohol (%)" )) %>%
  summarise(Frecuencia = sum(factor_expansion), .groups = "drop") %>%  # Sumar ponderaciones
  group_by(region) %>%  # Agrupar por región
  mutate(
  Porcentaje = round(Frecuencia / sum(Frecuencia) * 100, 1)  # Calcular porcentaje dentro de cada región
  ) %>%
  select(-Frecuencia) %>%  # Eliminar columna Frecuencia si no es necesaria
  pivot_wider(
    names_from = Variable, 
    values_from = Porcentaje,
    values_fill = 0) # Rellanar con valor 0
tabla_porcentajes_region
```

```{r, echo=TRUE, results="hide"}
chile_map <- st_read("C:/Users/natal/OneDrive - Universidad Alberto Hurtado/PERSONAL/DIPLOMADO DATA SCIENCE/CAPSTONE/proyecto_capstone_AA_NV/proyecto_capstone_AA_NV/Regiones")


```

```{r, echo=TRUE, results="hide"}
# Verificamos los nombres de la regiones en el archivo shapefile
unique(chile_map$Region)  

# Verificamos nombres en nuestra tabla
unique(tabla_porcentajes_region$region)

# Lamentablemente, los nombres de algunas regiones de nuestra tabla no coinciden con sus respectivos nombres en el shapefile descargado. Por ello tenemos que crear una tabla de equivalencias para recodificar los nombres del shapefile. 
recodificacion_regiones <- c(
  "Región de Aysén del Gral.Ibañez del Campo" = "Región de Aysén del General Carlos Ibáñez del Campo",
  "Región del Bío-Bío" = "Región del Biobío",
  "Región del Libertador Bernardo O'Higgins" = "Región del Libertador General Bernardo O'Higgins", "Región de Magallanes y Antártica Chilena" = "Región de Magallanes y de la Antártica Chilena"
)

# Recodificamos los nombres en el shapefile
chile_map <- chile_map %>%
  mutate(Region = recode(Region, !!!recodificacion_regiones))

# Aquí generamos el join necesario entre tablas
chile_map <- chile_map %>%
  left_join(tabla_porcentajes_region, by = c("Region" = "region"))

```

```{r, echo=TRUE, results="hide"}

# Crear el mapa con ajustes en tamaño de mapa y leyenda
ggplot(data = chile_map) +
  geom_sf(aes(fill = `Marihuana (%)`), color = "white", size = 0.2) + # Líneas divisorias blancas más delgadas
  scale_fill_gradientn(
    colors = c("#ffffcc", "#a1dab4", "#41b6c4", "#2c7fb8", "#253494"), # Paleta diferenciada de verdes a azules
    na.value = "grey90", # Color para valores NA
    name = "Marihuana (%)" # Título de la escala
  ) +
  labs(
    title = "Consumo de Marihuana por Región en Chile",
    subtitle = "Porcentaje de consumo según región",
    caption = "Fuente: Datos de consumo de marihuana y shapefile de regiones"
  ) +
  theme_minimal(base_size = 16) + # Base más grande para texto
  theme(
    panel.background = element_rect(fill = "#f5f5f5", color = NA), # Fondo claro
    panel.grid = element_blank(), # Sin cuadrícula
    plot.title = element_text(face = "bold", size = 18, hjust = 0.5), # Título más grande y centrado
    plot.subtitle = element_text(size = 14, hjust = 0.5, color = "grey40"), # Subtítulo estilizado
    legend.title = element_text(face = "bold", size = 12), # Título de la leyenda más pequeño
    legend.text = element_text(size = 10), # Texto de la leyenda reducido
    legend.key.size = unit(0.8, "cm"), # Tamaño de las claves de leyenda más pequeño
    legend.position = "right" # Leyenda a la derecha
  ) +
  coord_sf(expand = FALSE)  # Ajustar los márgenes del mapa


```

```{r,echo=TRUE, results="hide" }

# Crear el mapa con ajustes en tamaño de mapa y leyenda, utilizando el porcentaje de alcohol
ggplot(data = chile_map) +
  geom_sf(aes(fill = `Alcohol (%)`), color = "white", size = 0.2) + # Líneas divisorias blancas más delgadas
  scale_fill_gradientn(
    colors = c("#ffffcc", "#a1dab4", "#41b6c4", "#2c7fb8", "#253494"), # Paleta diferenciada de colores
    na.value = "grey90", # Color para valores NA
    name = "Alcohol (%)" # Título de la escala
  ) +
  labs(
    title = "Consumo de Alcohol por Región en Chile",
    subtitle = "Porcentaje de consumo según región",
    caption = "Fuente: Datos de consumo de alcohol y shapefile de regiones"
  ) +
  theme_minimal(base_size = 16) + # Base más grande para texto
  theme(
    panel.background = element_rect(fill = "#f5f5f5", color = NA), # Fondo claro
    panel.grid = element_blank(), # Sin cuadrícula
    plot.title = element_text(face = "bold", size = 18, hjust = 0.5), # Título más grande y centrado
    plot.subtitle = element_text(size = 14, hjust = 0.5, color = "grey40"), # Subtítulo estilizado
    legend.title = element_text(face = "bold", size = 12), # Título de la leyenda más pequeño
    legend.text = element_text(size = 10), # Texto de la leyenda reducido
    legend.key.size = unit(0.8, "cm"), # Tamaño de las claves de leyenda más pequeño
    legend.position = "right" # Leyenda a la derecha
  ) +
  coord_sf(expand = FALSE)  # Ajustar los márgenes del mapa




```

# Otras variables de interés para la aplicación de modelos de Machine Learning no supervisados

Para la generación de posibles clusters fueron seleccionadas, adicionalmente, un conjunto de variables relativas a la percepción de riesgo (PR), conducción con consumo declarado de alcohol o marihuana (CC_2 y CC_3, repectivamente) y opinión pública (OP_1 y OP_2). En relación a estas variables fueron seleccionadas solo las categorías que hacen referencia sea a alcohol o marihuana, ya que existen otras categorías sobre otros tipos de droga.

Las variables fueron recodificadas de variables categoricas a variables binarias para faciltiar el análsis. Estas recodificaciones fueron hechas en base a la presentación de resultados de la ENPG (2022).

## Percepción de Riesgo

Dentro de estas variables se encuentra la percepción de riesgo de consumir ciertos tipos de drogas o la frecuencia de consumo de estas. Para esta variable se transformo de una variable categorica (4 categorías) a una variabla binaria (2 categorías), donde los valores 1,2,3 fueron catalogados como "Ningún o algo de riesgo", mientras que el valor 4 fue catalago como "Gran riesgo". A partir de esto se identificaron los principales hábitos de consumo declarado de alcohol y marihuana que pueden tener un gran riesgo.

```{r}
# Recodificación de variables de Percepción
  senda <- senda %>%
    mutate(across(starts_with("pr"), ~ case_when(
      . %in% c(1,2,3) ~ 0,  # Valores 1 ningun riesgo se mantiene pero como 0
      . %in% (4) ~ 1,      # Valores que identifican algún riesgo se codifican como 1 de    algún riesgo
      TRUE ~ NA_real_          # Valores NA
    ))) %>%
    mutate(across(starts_with("pr"), ~ factor(., 
                                              levels = c(0, 1),
                                              labels = c("Ningún o algo de riesgo", "Gran riesgo"))))
# Definir las etiquetas
etiquetas_preguntas <- c(
  "pr_1_2_rp" = "Tomar más de 3 tragos ocasional",
  "pr_1_3_rp" = "Tomar más de 5 tragos diarios",
  "pr_1_4_rp" = "Marihuana de forma experimental",
  "pr_1_5_rp" = "Fumar marihuana frecuentemente")

# Crear la tabla con factor de expansión y etiquetas
tabla_pr_gran_riesgo_expansion <- senda %>%
  select(starts_with("pr"), factor_expansion) %>%  # Seleccionar las columnas que empiezan con "pr" y el factor de expansión
  summarise(across(starts_with("pr"), 
  ~ round(sum((. == "Gran riesgo") * factor_expansion, na.rm = TRUE) / sum(factor_expansion, na.rm = TRUE) * 100, 1))) %>%  #  factor de expansión
  pivot_longer(
    cols = everything(),
    names_to = "Pregunta",
    values_to = "Porcentaje_Gran_Riesgo"
  ) %>%
  mutate(Pregunta = recode(Pregunta, !!!etiquetas_preguntas)) %>%  # Aplicar etiquetas
  arrange(desc(Porcentaje_Gran_Riesgo))  # Ordenar en orden descendente

# Percepción a tabla HTML
tabla_pr_gran_riesgo_expansion %>%
  rename(
    "Percepción de riesgo" ="Pregunta",
    "Gran riesgo" = "Porcentaje_Gran_Riesgo" ) %>%
  kable("html", caption = "Porcentaje de Gran Riesgo por Pregunta") %>%
  kable_styling("striped", full_width = F) %>%
  kable_styling(font_size = 15)
```


La percepción de riesgo varía según las conductas relacionadas con el consumo de alcohol y marihuana. De este modo, tomar más de 5 tragos diarios tiene la mayor percepción de riesgo, con un 89.5% de las personas considerándolo un gran riesgo. Fumar marihuana frecuentemente es percibido como un gran riesgo por el 72.7% de la problación. Tomar más de 3 tragos ocasionalmente tiene una percepción de riesgo menor, con un 45.0%.Por último, consumir marihuana de forma experimental es visto como un gran riesgo por solo el 42.4% de las personas.

En base a lo descrito, la percepción de riesgo es significativamente mayor para comportamientos frecuentes o intensivos (como tomar más de 5 tragos diarios o fumar marihuana frecuentemente) en comparación con comportamientos ocasionales o experimentales.

## Opinión Pública

La ENPG 2022 contempla varios ítems (OP_1 y OP_2) sobre el nivel de acuerdo en temas relacionados con consumo, legalización y penalización relativa al porte y tráfico de drogas. Estas variables de opinión también fueron recodificadas de forma binaria para facilitar su análisis. Donde los valores 3 y 4 fueron dejados como No estoy de acuerdo, mientras que valores 1 y 2 fueron catalogados como Estoy de acuerdo. En esta tabla se representan los mayores niveles de acuerdo según diversos temas:

```{r}
# Recodificación de Var de opinión
senda <- senda %>%
  mutate(across(starts_with("op"), ~ case_when(
    . %in% c(1, 2) ~ 1,      # Valores 1 y 2 se recodifican como 1
    . %in% c(3, 4) ~ 0,      # Valores 3 y 4 se recodifican como 0
    TRUE ~ NA_real_   ))) %>% 
  mutate(across(starts_with("op"), ~ factor(., 
                                            levels = c(1, 0),
                                            labels = c("Estoy de acuerdo", "No estoy de acuerdo"))))
# Selección de Alcohol y Marihuana, y otros
tabla_op_opinion <- senda %>%
  select(op_1_1_rp, op_1_2_rp, op_1_4_rp, op_2_2_rp, op_2_3_rp, op_2_5_rp ) %>%
  summarise(across(everything(), ~ round(mean(. == "Estoy de acuerdo", na.rm = TRUE) * 100, 1))) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Pregunta",
    values_to = "Porcentaje_Acuerdo") %>%
  arrange(desc(Porcentaje_Acuerdo)) 

# Eiquetas
etiquetas_preguntas_op <- c(
  "op_1_1_rp" = "La mayoría de jóvenes consume Marihuana",
  "op_1_2_rp" = "La Marihuana produce menos daño que el Alcohol",
  "op_1_4_rp" = "La Marihuana debería ser legal para mayores de 18 años",
  "op_2_2_rp" = "Dar la misma pena a quienes trafican Marihuana como los que trafican cocaína o pasta base",
  "op_2_3_rp" = "Permitir el uso de Marihuana para fines terapéuticos",
  "op_2_5_rp" = "Penalizar el porte y consumo de marihuana aunque sea en pequeñas cantidades y para uso personal")

# Crear la tabla con factor de expansión y etiquetas
tabla_op_opinion_exp <- senda %>%
  select(starts_with("op"), factor_expansion) %>%  # Seleccionar las columnas que empiezan con "pr" y el factor de expansión
  summarise(across(starts_with("op"), 
  ~ round(sum((. == "Estoy de acuerdo") * factor_expansion, na.rm = TRUE) / sum(factor_expansion, na.rm = TRUE) * 100, 1))) %>%  #  factor de expansión
  pivot_longer(
    cols = everything(),
    names_to = "Pregunta",
    values_to = "Porcentaje_de_acuerdo"
  ) %>%
  mutate(Pregunta = recode(Pregunta, !!!etiquetas_preguntas_op)) %>%  # Aplicar etiquetas
  arrange(desc(Porcentaje_de_acuerdo))  # Ordenar en orden descendente

# Percepción a tabla HTML
tabla_op_opinion_exp %>%
  rename(
    "Frase" ="Pregunta",
    "Estoy de acuerdo" = "Porcentaje_de_acuerdo" ) %>%
  kable("html", caption = "Porcentaje de Nivel de Acuerdo por Pregunta") %>%
  kable_styling("striped", full_width = F) %>%
  kable_styling(font_size = 15)

```

Las alternativas donde existe mayor grado de acuerdo son "Permitir el uso de Marihuana para fines terapéuticos" (82,4%) y "La mayoría de jóvenes consume marihuana" (71,6%) lo que refleja una percepción extendida sobre su consumo en este grupo etario.

Existe un acuerdo moderado con respecto a las premisas "dar la misma pena a quienes trafican marihuana como los que trafican cocaína o pasta base" (60.9%) y a la premisa "penalizar el porte y consumo de marihuana auqnue sea en pequeñas cantidades y para uso personal" (55,7%) .

El menor grado de acuerdo se genera entorno a las premisas "La Marihuana debería ser legal para mayores de 18 años" (47,6%) y "La Marihuana produce menos daño que el Alcohol" (41,5%)

## Consumo y conducción

La ENPG 2022 también posee un apartado sobre consumo y conducción. En línea con nuestra investigación seleccionamos dos preguntas de caractér binario sobre conducción con consimo previo de alcohol (CC_2) o de marihuana (CC_3). Los resultados muestran un bajo porcentaje de este tipo de conductas de riesgo con un 3,9% de personas que afirma haber conducido con consumo previo de alcohol. Mientras que tan solo 1,2% afirma haber manejado después de consumir marihuana.

```{r}
# Datos de conducción
 senda <- senda %>%
    mutate(across(starts_with("cc"), ~ case_when(
      . %in% c(2) ~ 0,  # Valores 1 ningun riesgo se mantiene pero como 0
      . %in% (1) ~ 1,      # Valores que identifican algún riesgo se codifican como 1 de    algún riesgo
      TRUE ~ NA_real_          # Valores NA
    ))) %>%
    mutate(across(starts_with("cc"), ~ factor(., 
                                              levels = c(0, 1),
                                              labels = c("No", "Sí"))))
# Tabla
tabla_cc_conduccion <- senda %>%
  select(starts_with("cc")) %>%
  summarise(across(everything(), ~ round(mean(. == "Sí", na.rm = TRUE) * 100, 1))) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Pregunta",
    values_to = "Porcentaje_Conduce" ) %>%
  arrange(desc(Porcentaje_Conduce))

# Etiquetas
etiquetas_preguntas_cc <- c(
  "cc_2" = "Ha manejado despúes de beber Alcohol",
  "cc_3" = "Ha manejado después de fumar Marihuana")

# Crear la tabla con factor de expansión y etiquetas
tabla_cc_conduccion_exp <- senda %>%
  select(starts_with("cc"), factor_expansion) %>%  # Seleccionar las columnas que empiezan con "pr" y el factor de expansión
  summarise(across(starts_with("cc"), 
  ~ round(sum((. == "Sí") * factor_expansion, na.rm = TRUE) / sum(factor_expansion, na.rm = TRUE) * 100, 1))) %>%  #  factor de expansión
  pivot_longer(
    cols = everything(),
    names_to = "Pregunta",
    values_to = "Porcentaje_de_sí"
  ) %>%
  mutate(Pregunta = recode(Pregunta, !!!etiquetas_preguntas_cc)) %>%  # Aplicar etiquetas
  arrange(desc(Porcentaje_de_sí))  # Ordenar en orden descendente

# Percepción a tabla HTML
tabla_cc_conduccion_exp %>%
  rename(
    "Ha conducido" = "Pregunta",
    "Sí lo he hecho" = "Porcentaje_de_sí"
  ) %>%
  kable("html", caption = "Porcentaje Sí ha manejado bajo efectos de") %>%
  kable_styling("striped", full_width = F) %>%
  kable_styling(font_size = 15)  # Cerrar correctamente el paréntesis aquí
```

```{r}
rm(list = setdiff(ls(), "senda"))
```

# Modelo de Machine Learning


A partir de la recodificación y preparación de las variables anteriores se propone un modelo de Clustering para identificar los posibles grupos poblacionales. Para esto se harán diversos clusters en base a variables inciales de alcohol y variables de marihuana; esperamos encontrar diversos grupos en cuanto al consumo de alcohol/marihuana.

Se generaron dos bases, una solo con información de alcohol y otra solo con información de marihuana tipificadas por región.

```{r}
# Base nueva
senda_clusters_alcohol <- senda %>%
  select(region, 
         consumo_alcohol = oh_rec,
         percepcion_alcohol_ocasional = pr_1_2_rp, 
         percepcion_alcohol_frecuente = pr_1_3_rp, 
         maneja = cc_2) %>%
  mutate(across(-region, as.numeric))  # Convertir todo excepto 'region' a numérico

# Escalar las variables (excepto la región)
senda_clusters_alcohol <- senda_clusters_alcohol %>%
  mutate(across(-region, scale))  # Escalar las variables numéricas

# Manejo de valores faltantes: eliminar filas con NA
senda_clusters_alcohol <- na.omit(senda_clusters_alcohol)

# Asignar etiquetas de las regiones de Chile a la variable 'region'
regiones_chile <- c(
  "Arica y Parinacota", "Tarapacá", "Antofagasta", "Atacama", "Coquimbo",
  "Valparaíso", "Metropolitana", "O'Higgins", "Maule",
  "Ñuble", "Biobío", "Araucanía", "Los Ríos", "Los Lagos",
  "Aysén", "Magallanes")

# Crear la base con las regiones y las demás variables
senda_clusters_alcohol <- senda %>%
select(region, 
         consumo_alcohol = oh_rec,
         percepcion_alcohol_ocasional = pr_1_2_rp, 
         percepcion_alcohol_frecuente = pr_1_3_rp, 
         maneja = cc_2) %>%
  mutate(across(-region, as.numeric)) %>%  # Convertir todo excepto 'region' a numérico
  group_by(region) %>%  # Agrupar por región
  summarise(across(everything(), mean, na.rm = TRUE))  # Calcular promedio por región

# Asignar las etiquetas de las regiones
senda_clusters_alcohol <- senda_clusters_alcohol %>%
  mutate(region = factor(region, levels = 1:16, labels = regiones_chile)) %>%
  column_to_rownames(var = "region")  # Convertir la columna 'region' en filas
```

## PCA Alcohol

Una vez estandarizadas las variables y agrupadas por su promedio por región. Utilizaremos un Análisis de Componentes Principales (PCA) para transformar los datos originales estandarizados en nuevas variables que explican la variación de los datos.

La justificación del uso de PCA está relacionada con reducir la dimensionalidad y poder, de esta manera, identificar los componentes principales que expliquen de mejor manera la varianza de los datos utilizados para realizar clustering.

Los resultados arrojaron 4 componentes principales que pueden ayudar a entender la asociación de las variables y el componente principal. En la tabla se observa la contribución de cada variable al componente principal. Donde valores más cercanos al 1 o -1 indican la influencia que tiene ese componente principal. Por ejemplo nuestra variable de interés sobre prevalencia de alcohol que es oh_rec en PC1 posee -0.510 que tiene una contribución negativa, siendo un factor importante en la variabilidad que puede explicar el PC1; Mientras que en PC3 posee un valor positivo de 0,681 de forma que este componente está influenciado de manera significativa pero inversa a la variable oh_rec.

En cuanto la interpratación de puntuaciones de (PCA\$X) cada valor refiere a cuanto puede contribuir cada componente a la representación de variabilidad de cada grupo. Esto permite identificar con mayor precisión para agrupar observaciones y visualizar cada PCA.

También se realizaron pruebas de varianza y varianza acumulada para identificar cuantos componentes son necesarios para explicar de forma significativa la varianza. Esto para reducir la cantidad de PCA y no perder demasiada información. Primero realizamos una prueba de varianza y luego la acumulada, en la varianza acumulada identificamos que con 3 PC explicamos más del 90% de la varianzasiendo la mayor parte de información, por tanto el último componente principal solo aporta un 9% de varianza.

```{r, echo=TRUE, results="hide"}
# Componentes Principales 
pca <- prcomp(senda_clusters_alcohol, scale = TRUE) #Calculo de PCA
round(pca$rotation,3) # Visualización
head(pca$x) # Puntuaciones de obs en PCA
# Varianza 
prop_varianza  <- pca$sdev^2 / sum(pca$sdev^2)
prop_varianza
# Varianza acumulada
prop_varianza_acum <- cumsum(prop_varianza)
round(prop_varianza_acum,2)
# Gráfico
# Crear el data frame para graficar
# Crear el data frame filtrando solo los primeros 4 componentes
varianza_data <- data.frame(
  prop_varianza_acum = cumsum(prop_varianza)[1:4],
  pc = 1:4
)

```
```{r}
# Instalar librería si no está instalada
if (!require(kableExtra)) install.packages("kableExtra")

library(kableExtra)

# Crear el primer conjunto de datos
tabla1 <- data.frame(
  Variable = c("consumo_alcohol", "percepcion_alcohol_ocasional", 
               "percepcion_alcohol_frecuente", "maneja"),
  PC1 = c(-0.629, 0.416, -0.053, -0.655),
  PC2 = c(-0.171, -0.577, -0.787, -0.138),
  PC3 = c(0.452, 0.665, -0.593, 0.037),
  PC4 = c(0.609, -0.227, 0.163, -0.743)
)

# Crear el segundo conjunto de datos
tabla2 <- data.frame(
  Region = c("Arica y Parinacota", "Tarapacá", "Antofagasta", "Atacama", 
             "Coquimbo", "Valparaíso"),
  PC1 = c(-0.34191312, 1.20449934, 0.09628096, 0.33677886, 0.39243032, 1.34075475),
  PC2 = c(-0.3840387, 1.0557723, -0.6874829, -1.9445260, 0.6975287, -0.2033517),
  PC3 = c(-0.3954515, 0.9550266, 1.7066983, 1.2411086, -0.3176753, -0.6874840),
  PC4 = c(0.2560324, -0.0239736, 0.4814640, 0.3974548, 0.9013300, -0.2121714)
)

# Tabla 1: Rotaciones
kable(tabla1, caption = "Rotaciones de Componentes Principales", digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

# Tabla 2: Puntuaciones de las Regiones
kable(tabla2, caption = "Puntuaciones de las Regiones en los Componentes Principales", digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```


En los siguientes dos gráficos se muestra primero la varianza acumulada según los PCA, donde con 3 PCA ya tenemos el 90% de la varianza. Minetras que en el otro gráfico se observa la distribución regional del país en cuanto a variables de consumo de alcohol.

Acá se puede observar que regiones como Bío-Bío tiene mayor probabilidad de consumo de alcohol que la Araucanía, y además mayor probabilidad de encontrar personas que manejan bajo el efecto del alcohol. No así en regiones como Arica y Tarapacá, Valparaíso y la Metropolitana.

En cuanto las variables de percepción de riesgo sobre tomar alcohol de manera ocasional y frecuentemente, regiones como Aysén y Atacama se encuentran cercanas a considerar ambos hábitos como riesgosos, a diferencia de regiones como Maule, O'higgins e incluso Los Lagos que se encuentra más alejados.

```{r}
# Gráfico de la varianza acumulada
ggplot(data = varianza_data, aes(x = pc, y = prop_varianza_acum)) +
  geom_point(color = "blue", size = 3) +  # Puntos en azul
  geom_line(color = "darkblue", size = 1) +  # Línea azul oscuro
  theme_bw() +  # Tema de fondo limpio
  labs(
    title = "Proporción de varianza explicada acumulada (primeros 4 PCA)",
    x = "Componente principal",
    y = "Prop. varianza explicada acumulada"
  ) +
  scale_x_continuous(breaks = 1:4) +  # Mostrar solo los primeros 4 componentes
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))  # Etiquetas en porcentaje

# Gráfico de regiones
pca$rotation <- -pca$rotation
pca$x        <- -pca$x
biplot(pca, scale = 0, cex = 0.5, col = c("blue2", "red2"))
```

## PCA Marihuana

Obtenido los PCA de alcohol, también realizamos un análisis de componentes principales para nuestra variable de Marihuana siguiendo los mismos pasos de estandarización y pruebas de varianza.

Esta selección cumple los mismos objetivos de identificar las principales variables que explican la varianza de los datos para generar clusters. Se utilizaron las mismas variables de Alcohol pero especificas de Marihuana. Siendo mar_rec la prevelancia de consumo (declarado) de marihuana, percepción de riesgo sobre el consumo de marihuana, si ha  manejado habiendo consimido de la marihuana.

En cuanto a los PCA, se generaron 6 componentes principales. Esto debido a la mayor cantidad de variables vs. el modulo de Alcohol. Nuestra variable mar_rec tiene un valor positivo de correlación en PC1, siendo evidentemente el componente principal que puede explicar de mejor forma el consumo de marihuana.

Finalmente, las pruebas de varianza y varianza acumulada de los primeros 3 componentes principales explica casi un 90% de la varianza, mientras que con los otros solo se explica el 10% restante. Esto es importante ya que perdemos poca información con el menor número de grupos posibles.

```{r}
# Asignar etiquetas breves a las variables
senda_clusters_mar <- senda %>%
  select(region, 
         consumo_marihuana = mar_rec, 
         riesgo_marihuana_experimental = pr_1_4_rp, 
         riesgo_marihuana_frecuente = pr_1_5_rp, 
         maneja = cc_3, 
         permitir_marihuana_terapeutico = op_2_3_rp, 
         marihuana_menos_dano_que_alcohol = op_1_2_rp) %>%
  mutate(across(-region, as.numeric))  # Convertir todo excepto 'region' a numérico

# Escalar las variables (excepto la región)
senda_clusters_mar <- senda_clusters_mar %>%
  mutate(across(-region, scale))  # Escalar las variables numéricas

# Manejo de valores faltantes: eliminar filas con NA
senda_clusters_mar <- na.omit(senda_clusters_mar)

# Etiquetas de las regiones de Chile
regiones_chile <- c(
  "Arica y Parinacota", "Tarapacá", "Antofagasta", "Atacama", "Coquimbo",
  "Valparaíso", "Metropolitana", "O'Higgins", "Maule",
  "Ñuble", "Biobío", "Araucanía", "Los Ríos", "Los Lagos",
  "Aysén", "Magallanes")

# Agrupar por región y calcular promedios
senda_clusters_mar <- senda %>%
  select(region, 
         consumo_mar = mar_rec, 
         marihuana_experimental = pr_1_4_rp, 
         marihuana_frecuente = pr_1_5_rp, 
         maneja = cc_3, 
         permitir_marihuana_terapeutico = op_2_3_rp, 
         marihuana_menos_dano_que_alcohol = op_1_2_rp) %>%
  mutate(across(-region, as.numeric)) %>%  # Convertir todo excepto 'region' a numérico
  group_by(region) %>%  # Agrupar por región
  summarise(across(everything(), mean, na.rm = TRUE))  # Calcular promedio por región

# Asignar las etiquetas de las regiones
senda_clusters_mar <- senda_clusters_mar %>%
  mutate(region = factor(region, levels = 1:16, labels = regiones_chile)) %>%
  column_to_rownames(var = "region")  # Convertir la columna 'region' en filas

```

```{r,echo=TRUE, results="hide" }
# Componentes Principales 
pca_mar <- prcomp(senda_clusters_mar, scale. = TRUE) # Cálculo de PCA
round(pca_mar$rotation, 3) # Visualización de las cargas de las variables
head(pca_mar$x) # Puntuaciones de las observaciones en PCA

# Varianza explicada
prop_varianza_mar <- pca_mar$sdev^2 / sum(pca_mar$sdev^2) # Proporción de varianza explicada
prop_varianza_mar

# Varianza acumulada
prop_varianza_acum_mar <- cumsum(prop_varianza_mar) # Cálculo de la varianza acumulada
round(prop_varianza_acum_mar, 2)

# Gráfico de varianza explicada acumulada
# Crear un data frame con los primeros 4 componentes principales
varianza_data_mar <- data.frame(
  prop_varianza_acum_mar = prop_varianza_acum_mar[1:4],
  pc_mar = 1:4
)

```
```{r}

# Crear la primera tabla: Rotaciones
tabla1 <- data.frame(
  Variable = c("consumo_mar", "marihuana_experimental", 
               "marihuana_frecuente", "maneja", 
               "permitir_marihuana_terapeutico", "marihuana_menos_dano_que_alcohol"),
  PC1 = c(0.502, -0.438, -0.547, 0.438, -0.215, -0.136),
  PC2 = c(0.200, -0.130, 0.112, 0.304, 0.675, 0.618),
  PC3 = c(0.253, 0.556, 0.101, 0.393, 0.364, -0.574),
  PC4 = c(-0.018, -0.291, -0.366, -0.552, 0.588, -0.360),
  PC5 = c(-0.772, 0.048, -0.451, 0.429, 0.122, -0.002),
  PC6 = c(0.218, 0.628, -0.584, -0.269, -0.069, 0.374)
)

# Crear la segunda tabla: Puntuaciones de las regiones
tabla2 <- data.frame(
  Region = c("Arica y Parinacota", "Tarapacá", "Antofagasta", "Atacama", 
             "Coquimbo", "Valparaíso"),
  PC1 = c(0.36421749, -2.63681354, -1.46742238, -1.42310937, 2.10936309, -0.07524146),
  PC2 = c(1.0073284, 1.3691836, 0.8707461, -0.3251271, -1.3864812, -0.6889271),
  PC3 = c(-0.06596363, 0.09782481, 0.26646992, 2.56132225, 0.15316809, -0.43461619),
  PC4 = c(0.1045180, -0.4632197, 0.8664489, -0.5755338, 0.6684709, 0.1863619),
  PC5 = c(0.8278329, 0.3965407, -0.1187327, -0.7233270, -0.4154565, -0.2606413),
  PC6 = c(-0.12189255, 0.20554528, 0.42498888, -0.02268974, 0.13894490, 0.11577817)
)

# Tabla 1: Rotaciones
kable(tabla1, caption = "Rotaciones de Componentes Principales (Marihuana)", digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

# Tabla 2: Puntuaciones de las Regiones
kable(tabla2, caption = "Puntuaciones de las Regiones en los Componentes Principales (Marihuana)", digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```


Para una mejor visualización de la varianza de nuestras variables en las regiones de Chile. Primero se muestra el gráfico de varianza acumulada y en segundo la distribución de las regiones. En esto identificamos que:

Como mencionamos en el consumo y regiones, Los Lagos es una región cercana a nuestra variable mar_rec, indicando que el consumo de marihuana es predominante a comparación de otres regiones del país siendo casi la única región relativamente cercana tanto al consumo como al manejar después de haber fumado marihuana. Por lo que las otras regiones es poco probable encontrar consumidores de Marihuana.

Con respecto a la percepción de riesgo de fumar marihuana frecunemente y de uso experimental, Arica y Tarapacá y Atacama se encuentran cercanas a estas variables, por lo que es probable que las personas consideren que es riesgoso. No así en regiones como Coquimbo o Bío-Bío que si bien no es predominante el consumo de marihuana no consideran riesgosos esos habitos.

```{r}
# Gráfico de la varianza acumulada
ggplot(data = varianza_data_mar, aes(x = pc_mar, y = prop_varianza_acum_mar)) +
  geom_point(color = "blue", size = 3) +  # Puntos en azul
  geom_line(color = "darkblue", size = 1) +  # Línea azul oscuro
  theme_bw() +  # Tema de fondo limpio
  labs(
    title = "Proporción de varianza Mar explicada acumulada (primeros 4 PCA)",
    x = "Componente principal",
    y = "Prop. varianza explicada acumulada"
  ) +
  scale_x_continuous(breaks = 1:4) +  # Mostrar solo los primeros 4 componentes
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))  # Etiquetas en porcentaje

# Gráfico de regiones
biplot(pca_mar, scale = 0, cex = 0.5, col = c("blue2", "red2"))
```

# Cluster

## Cluster Alcohol

Obtenidas las bases simplificadas y estandarizadas procedemos con la generación de clusters.

Usaremos un K-means clustering para identificar los posibles grupos en la base. Primero ejectuamos una semilla para asegurar que se obtengan los mismos resultados debido a la aleatoriedad de los centroides (los puntos que representan cada cluster en el algoritmo). Luego implementamos el método wss para identificar el número óptimo de clusters para el análisis de los k-means. En el gráfico sobre el método se observa que al tener 1 o 2 cluster la suma de los errores cuadradas es alta lo que no asegura una variabilidad en los datos, pero a medida que se suman más cluster los datos se van agrupando y explican el modolo. En base al gráfico optamos por 4 cluster para el análisis.

Con los resultados del k-means identificamos que las regiones fueron agrupadas en 4 grupos en base a las características de las variables seleccionadas sobre consumo, percepción de riesgo y comportamiento de manejar bajo efectos del alcohol, en estos grupos se distribuye:

\- Grupo 1: Tarapacá, Valparaíso, Araucanía y Ñuble.

\- Grupo 2: Arica, Coquimbo, Metropolitana, Maule, Los Ríos, Aysén y Magallanes.

-Grupo 3: Antofagasta, Atacama y Maule.

\- Grupo 4: Los Lagos.

En cuanto a los resultados promedios de cada cluster podemos inferir lo siguiente:

\- Grupo 1: Las regiones presentan un menor consumo de alcohol a comparación de los otros clusters, tienen una alta percepción de riesgo y es poco probable que manejen bajo efectos del alcohol.

\- Grupo 2: Las regiones presentan levemente consumo de alcohol, baja percepción de riesgo a beber de forma ocasial pero sí a beber frecuentemente, y poco probable que manejen bajo efectos del alcohol.

\- Grupo 3: Regiones más probable al consumo de alcohol, percepción de riesgo moderada al consumo ocasional pero alta a beber frecuentemente y poco probable que manejen bajo efectos del alcohol

\- Grupo 4: Región de los Lagos queda desagrupado de las otras regiones, esto debido a que es más probable que se consuma alcohol, baja percepción de riesgo al consumo ocasional y de beber frecuentemente. También presente un leve aumento en conducir bajo efectos del alcohol, si bien es bajo, es el grupo más alto.

En la visualización de los clusters se realizó en base al PCA obtenido de alcohol, donde buscamos representar las regiones según los dos principales componentes principales. Cada punto es una región y los colores el cluster al que pertencen. Por tanto, regiones que comparten color y se encuentran cercas es debido a que comparten características similares como es el caso de Valparaíso y Tarapacá.

```{r, echo=TRUE, results="hide" }
# Método del codo
set.seed(123)  # Para reproducibilidad
wss <- sapply(1:10, function(k) {kmeans(senda_clusters_alcohol, centers = k, nstart = 25)$tot.withinss})
plot(1:10, wss, type = "b", main = "Método del Codo", xlab = "Número de clusters", ylab = "Suma de errores al cuadrado")

# Aplicar K-means con k = 3
set.seed(123)
kmeans_result <- kmeans(senda_clusters_alcohol, centers = 4, nstart = 25)

# Ver los resultados
kmeans_result$cluster  # Asignación de cada observación a un cluster

# Visualización de los clusters en las dos primeras componentes principales
pca_result <- pca$x  # Usar las puntuaciones de PCA
plot(pca_result[, 1], pca_result[, 2], 
     col = kmeans_result$cluster, pch = 16, 
     main = "Clustering de K-means",
     xlab = "Componente Principal 1",  # Nombre del eje X
     ylab = "Componente Principal 2")  # Nombre del eje Y


# Obtener las medias de las variables para cada cluster
cluster_means <- aggregate(senda_clusters_alcohol, by = list(Cluster = kmeans_result$cluster), FUN = mean)

cluster_means %>%
  rename(
    "N° de Cluster" = "Cluster",
    "Consumo de Alcohol" = "consumo_alcohol",
    "Percepción beber ocasional" = "percepcion_alcohol_ocasional",
    "Percepción beber frecuentemente" = "percepcion_alcohol_frecuente",
    "Manejo bajo efectos" = "maneja") %>%
  kable("html", caption = "Porcentaje de consumo por tipo y Nivel socioecónomico") %>%
  kable_styling("striped", full_width = F) %>%
  kable_styling(font_size = 15)


# Agregar los nombres de las regiones
text(pca_result[, 1], pca_result[, 2], labels = rownames(senda_clusters_alcohol), 
     cex = 0.7, pos = 3, col = "black")  # 'cex' ajusta el tamaño del texto, 'pos' coloca el texto arriba del punto

# Agregar leyenda
legend("bottomleft", 
       legend = paste("Cluster", 1:4), 
       col = 1:4, 
       pch = 16, 
       title = "Clusters")
```

## Cluster Marihuana

En la visualización de los clusters se realizó en base al PCA obtenido de alcohol, donde buscamos representar las regiones según los dos principales componentes principales. Cada punto es una región y los colores el cluster al que pertencen. Por tanto, regiones que comparten color y se encuentran cercas es debido a que comparten características similares como es el caso de Valparaíso y Tarapacá.

Al igual que con el Alcohol se siguieron los mismos pasos para realizar clustering con personas que consumen Marihuana. Usamos una semilla para generar mismos resultados, y K-means para identificar el número óptimo de clusters. En cuanto a los resultados de Marihuana:

El número óptimos de clusters es 4, donde existe un bajo número de errores al cuadrado. Por, tanto se generaron 4 grupos agrupado de la siguiente forma:

\- Grupo 1: Arica y Parinocata, Metropolitana, Maule, Ñuble, Los Ríos y Aysén - Grupo 2: Antofagasta, Valparaíso y Magallanes

\- Grupo 3: Tarapacá, Atacame u Araucanía.

\- Grupo 4: Coquimbo, O'Higgins, Bio-Bío y Los Lagos

En cuanto al resultado promedio por grupo se observa lo siguiente:

\- Grupo 1: Región con personas con consumo moderado de marihuana, percepción moderada al consumo experimental y alta al consumo frecuente. Poco probable conducir bajo efectos de la marihuana. Sobre opinión pública Están más de acuerdo con permitir la marihuana de uso terapeutico y que la marihuana hace menos daño que el alcohol.

\- Grupo 2: Las regiones del cluster 2 presentan un consumo moderado de marihuana, percepción de riesgo leve al uso de marihuana de forma experimental pero una percepción de riesgo más alta al consumir marihuana de forma frecuente. Es poco probable que manejen después de consumir marihuana. En cuanto opinión pública están menos de acuerdo con el uso de forma terapeutica y están más de acuerdo con que hace menos daño alcohol.

\- Grupo 3: Regiones con el menor consumo de los tres clusters, y mayores niveles de percepción de riesgo sobre el consumo tanto experimental como frecuente. También menor probabilidad de manejar bajo los efectos de la marihuana. Sobre opinión pública es el grupo que está más de acuerdo con el uso de marihuana de forma experimental pero presenta niveles moderados en cuanto que hace menos daño que el alcohol.

\- Grupo 4: Regiones con el mayor consumo de marihuana, presenta menor percepción de riesgo al uso experimental y frecuente. Mayor probabilidad de manejar bajo efectos de la marihuana. Aunque presenta menor niveles de opinión pública sobre el uso de forma experimental y nivel moderado de dañp que el alcohol.

En la visualización se observan las distintas agrupaciones de las regiones y su grupo correspondiente. Donde el cluster 1 se encuentra mucho más agrupado a diferencia de los otros. Sin embargo, la mayoría de casos se encuentran relativamente cerca debido a que existen bajo niveles de consumo a nivel regional, siendo las principales discrepancias la percepción de riesgo sobre el consumo de Marihuana.

```{r, echo=TRUE, results="hide"}
# Método del codo
set.seed(123)  # Para reproducibilidad
wss_mar <- sapply(1:10, function(k) {
  kmeans(senda_clusters_mar, centers = k, nstart = 25)$tot.withinss
})
plot(1:10, wss_mar, type = "b", main = "Método del Codo", xlab = "Número de clusters", ylab = "Suma de errores al cuadrado")

# Aplicar K-means con k = 4 (ajusté el número de clusters a 4)
set.seed(123)
kmeans_result_mar <- kmeans(senda_clusters_mar, centers = 4, nstart = 25)
kmeans_result_mar$cluster  # Asignación de cada observación a un cluster


# Tabla
cluster_means_mar <- aggregate(senda_clusters_mar, by = list(Cluster = kmeans_result_mar$cluster), FUN = mean)

# Mostrar las medias de las variables para cada cluster
cluster_means_mar %>%
  rename(
    "N° de Cluster" = "Cluster",
    "Consumo de Marihuana" = "consumo_mar",
    "Percepción Marihuana experimental" = "marihuana_experimental",
    "Percepción Marihuana frecuentemente" = "marihuana_frecuente",
    "Manejo bajo efectos" = "maneja",
     "Acuerdo sobre Marihuana terapeútica" = "permitir_marihuana_terapeutico",
    "Acuerdo sobre Marihuana menos dañina que alcohol" = "marihuana_menos_dano_que_alcohol"
    ) %>%
  kable("html", caption = "Porcentaje de consumo por tipo") %>%
  kable_styling("striped", full_width = F) %>%
  kable_styling(font_size = 15)


# Visualización de los clusters en las dos primeras componentes principales
pca_result_mar <- pca_mar$x  # Usar las puntuaciones de PCA
plot(pca_result_mar[, 1], pca_result_mar[, 2], 
     col = kmeans_result_mar$cluster, pch = 16, 
     main = "Clustering de K-means",
     xlab = "Componente Principal 1",  # Nombre del eje X
     ylab = "Componente Principal 2")  # Nombre del eje Y

text(pca_result_mar[, 1], pca_result_mar[, 2], labels = rownames(senda_clusters_mar), 
     cex = 0.7, pos = 3, col = "black")  
legend("bottomright", 
       legend = paste("Cluster", 1:4), 
       col = 1:4, 
       pch = 16, 
       title = "Clusters")
```

# Conclusiones: 

A partir del análisis realizado sobre el consumo de alcohol y marihuana en diferentes regiones, se pueden extraer las siguientes conclusiones principales:

1. Análisis del Consumo de Alcohol

PCA y Varianza: Mediante el Análisis de Componentes Principales (PCA), se identificaron 4 componentes principales que explican más del 90% de la variabilidad en los datos, con los primeros 3 componentes explicando la mayor parte de la varianza acumulada. Esto permitió simplificar el conjunto de datos sin pérdida significativa de información, destacando el consumo de alcohol (oh_rec) como una variable clave en los primeros componentes.

Clusters: El análisis de clustering generó 4 grupos bien definidos:

Grupo 1: Regiones con menor consumo de alcohol, alta percepción de riesgo y baja probabilidad de manejar bajo efectos del alcohol.
Grupo 2: Regiones con consumo moderado, percepción de riesgo baja al consumo ocasional, pero alta al frecuente, con baja probabilidad de manejar habiendo consumodo alcohol previamente.
Grupo 3: Regiones con mayor probabilidad de consumo, percepción moderada a baja sobre el riesgo y de manejar habiendo consumodo alcohol previamente.
Grupo 4 (Los Lagos): Presenta un perfil distinto, con mayor consumo, baja percepción de riesgo al consumo ocasional y frecuente, y la mayor probabilidad de manejar habiendo consumodo alcohol previamente.

2. Análisis del Consumo de Marihuana

PCA y Varianza: Para las variables relacionadas con marihuana, se identificaron 6 componentes principales, donde los primeros 3 explican casi el 90% de la variabilidad. La variable mar_rec (prevalencia de consumo declarado de marihuana) destacó en el primer componente como un determinante clave.

Clusters: De manera similar al alcohol, se generaron 4 clusters:

Grupo 1: Consumo moderado, percepción moderada del riesgo experimental y alta al frecuente. Apoyo al uso terapéutico de marihuana y acuerdo con que causa menos daño que el alcohol.
Grupo 2: Consumo moderado, baja percepción del riesgo al uso experimental y alta al frecuente, con menor apoyo al uso terapéutico, pero más acuerdo con que la marihuana es menos dañina que el alcohol.
Grupo 3: Menor consumo de marihuana, mayor percepción de riesgo tanto en uso experimental como frecuente, y mayor apoyo al uso terapéutico.
Grupo 4: Mayor consumo de marihuana, baja percepción de riesgo, mayor probabilidad de manejar bajo efectos de la sustancia, y niveles bajos de apoyo al uso terapéutico.

3. Hallazgos Generales

Las regiones chilenas presentan diferencias significativas en el consumo, percepción de riesgo y comportamientos asociados tanto para el alcohol como para la marihuana.
Los patrones observados muestran que las variables relacionadas con la percepción de riesgo son determinantes clave en la segmentación de las regiones, afectando tanto los niveles de consumo como las actitudes hacia el manejo bajo los efectos de estas sustancias.
La región de Los Lagos destaca como un caso atípico en el consumo de alcohol, mientras que en el caso de marihuana, las diferencias se distribuyen más uniformemente entre los clusters, siendo la percepción de riesgo un factor diferenciador clave.

4. Implicaciones y Aplicaciones

Este análisis podría representar una base para el diseño de estrategias regionales de prevención y políticas públicas. Las regiones con mayor consumo o baja percepción de riesgo pueden ser objetivo de campañas específicas para reducir el consumo y sus efectos asociados, mientras que las regiones con mayor percepción de riesgo podrían requerir menos intervención directa en términos de consumo, pero más educación sobre los efectos de conducción bajo sustancias.

